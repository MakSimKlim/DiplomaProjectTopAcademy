@page
@model SubscriptionModel
@using DiplomaProjectTopAcademy.Models
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Subscription";
    var appUser = await UserManager.GetUserAsync(User);
}

<h2>Моя подписка</h2>
<hr />

<p><strong>Текущий тариф:</strong> @appUser.SubscriptionType</p>
<p><strong>Дата окончания:</strong> @appUser.SubscriptionEndDate?.ToString("dd.MM.yyyy HH:mm:ss")</p>
<p><strong>Статус:</strong> @(appUser.IsActive ? "Активна" : "Неактивна")</p>

<div id="countdown" class="text-primary fw-bold"></div>

<form asp-controller="Subscription" asp-action="ExtendSubscription" method="post" class="mt-3">
    <button type="submit" name="plan" value="@appUser.SubscriptionType" class="btn btn-success">
        Продлить подписку
    </button>
</form>

@section Scripts {
    <script>
        var endDate = new Date("@appUser.SubscriptionEndDate?.ToString("yyyy-MM-ddTHH:mm:ss")");

        function updateCountdown() {
            var now = new Date();
            var diff = endDate - now;

            if (diff <= 0) {
                document.getElementById("countdown").innerHTML = "Подписка истекла!";
                return;
            }

            var days = Math.floor(diff / (1000 * 60 * 60 * 24));
            var hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            var minutes = Math.floor((diff / 1000 / 60) % 60);
            var seconds = Math.floor((diff / 1000) % 60);

            document.getElementById("countdown").innerHTML =
                "Осталось: " + days + " дн " + hours + " ч " + minutes + " мин " + seconds + " сек";
        }

        setInterval(updateCountdown, 1000);
        updateCountdown();
    </script>
}
